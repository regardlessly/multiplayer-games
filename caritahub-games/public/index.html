<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CaritaHub Games</title>
  <link rel="stylesheet" href="/css/style.css" />
</head>
<body>
  <div id="app" class="games-lobby">
    <header>
      <h1>CaritaHub Games</h1>
      <p class="subtitle">Choose a game to play with friends</p>
    </header>

    <main>
      <p class="section-title">Available Now</p>
      <div class="games-grid">

        <a class="game-card" href="/lobby.html?game=xiangqi">
          <div class="game-card-banner">‚ôü</div>
          <div class="game-card-body">
            <div class="game-card-title">Ë±°Ê£ã Xiangqi</div>
            <div class="game-card-subtitle">Chinese Chess ‚Äî 2 players</div>
            <div class="game-card-meta">
              <span class="badge badge-ready">Ready to play</span>
              <span class="badge">2 players</span>
            </div>
          </div>
        </a>

        <a class="game-card" href="/lobby.html?game=chess">
          <div class="game-card-banner">‚ôî</div>
          <div class="game-card-body">
            <div class="game-card-title">Western Chess</div>
            <div class="game-card-subtitle">Chess ‚Äî 2 players</div>
            <div class="game-card-meta">
              <span class="badge badge-ready">Ready to play</span>
              <span class="badge">2 players</span>
            </div>
          </div>
        </a>

        <a class="game-card" href="/lobby.html?game=chordaidi">
          <div class="game-card-banner">üÉè</div>
          <div class="game-card-body">
            <div class="game-card-title">Â§ßËÄÅ‰∫å Chor Dai Di</div>
            <div class="game-card-subtitle">Big Two ‚Äî 4 players</div>
            <div class="game-card-meta">
              <span class="badge badge-ready">Ready to play</span>
              <span class="badge">4 players</span>
            </div>
          </div>
        </a>

      </div>

      <!-- ‚îÄ‚îÄ Leaderboard ‚îÄ‚îÄ -->
      <p class="section-title">Leaderboard</p>
      <div id="leaderboardPanel" class="leaderboard-panel">
        <div class="lb-tabs">
          <button class="lb-tab active" data-game="all">All Games</button>
          <button class="lb-tab" data-game="xiangqi">Ë±°Ê£ã</button>
          <button class="lb-tab" data-game="chess">Chess</button>
          <button class="lb-tab" data-game="chordaidi">Â§ßËÄÅ‰∫å</button>
        </div>
        <div id="lbBody" class="lb-body">
          <p class="lb-empty">No games played yet.</p>
        </div>
      </div>

      <p class="section-title">Coming Soon</p>
      <div class="games-grid">

        <div class="game-card coming-soon">
          <div class="game-card-banner">üé±</div>
          <div class="game-card-body">
            <div class="game-card-title">Bingo</div>
            <div class="game-card-subtitle">Up to 8 players, facilitator mode</div>
            <div class="game-card-meta">
              <span class="badge badge-soon">Coming soon</span>
              <span class="badge">Up to 8 players</span>
            </div>
          </div>
        </div>

        <div class="game-card coming-soon">
          <div class="game-card-banner">‚ùì</div>
          <div class="game-card-body">
            <div class="game-card-title">Trivia Quiz</div>
            <div class="game-card-subtitle">Singapore-themed, buzz-in mechanic</div>
            <div class="game-card-meta">
              <span class="badge badge-soon">Coming soon</span>
              <span class="badge">2‚Äì6 players</span>
            </div>
          </div>
        </div>

        <div class="game-card coming-soon">
          <div class="game-card-banner">üé≤</div>
          <div class="game-card-body">
            <div class="game-card-title">È£ûË°åÊ£ã Ludo</div>
            <div class="game-card-subtitle">Pan-ASEAN classic, up to 4 players</div>
            <div class="game-card-meta">
              <span class="badge badge-soon">Coming soon</span>
              <span class="badge">2‚Äì4 players</span>
            </div>
          </div>
        </div>

      </div>
    </main>
  </div>
  <script>
  (function () {
    'use strict';
    let allData = {};
    let activeGame = 'all';

    const GAME_LABELS = { xiangqi: 'Ë±°Ê£ã Xiangqi', chess: 'Western Chess', chordaidi: 'Â§ßËÄÅ‰∫å Chor Dai Di' };
    const RANK_CLASSES = ['lb-rank-gold', 'lb-rank-silver', 'lb-rank-bronze'];

    function renderRows(entries) {
      const body = document.getElementById('lbBody');
      if (!entries || !entries.length) {
        body.innerHTML = '<p class="lb-empty">No games played yet.</p>';
        return;
      }
      body.innerHTML = entries.map((e, i) => {
        const rankClass = i < 3 ? RANK_CLASSES[i] : '';
        const rankSymbol = i === 0 ? 'ü•á' : i === 1 ? 'ü•à' : i === 2 ? 'ü•â' : `${i + 1}`;
        return `<div class="lb-row">
          <span class="lb-rank ${rankClass}">${rankSymbol}</span>
          <span class="lb-name">${escHtml(e.name)}</span>
          <span class="lb-wins">${e.wins} win${e.wins !== 1 ? 's' : ''}</span>
        </div>`;
      }).join('');
    }

    function escHtml(s) {
      return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
    }

    function showTab(game) {
      activeGame = game;
      document.querySelectorAll('.lb-tab').forEach(t => t.classList.toggle('active', t.dataset.game === game));
      if (game === 'all') {
        // Aggregate across all game types
        const agg = new Map();
        for (const entries of Object.values(allData)) {
          for (const e of entries) agg.set(e.name, (agg.get(e.name) || 0) + e.wins);
        }
        const sorted = Array.from(agg.entries()).map(([name, wins]) => ({ name, wins }))
          .sort((a, b) => b.wins - a.wins).slice(0, 10);
        renderRows(sorted);
      } else {
        renderRows(allData[game] || []);
      }
    }

    async function fetchLeaderboard() {
      try {
        const res = await fetch('/api/leaderboard');
        allData = await res.json();
        showTab(activeGame);
      } catch (_) { /* server not ready yet */ }
    }

    document.querySelectorAll('.lb-tab').forEach(btn => {
      btn.addEventListener('click', () => showTab(btn.dataset.game));
    });

    fetchLeaderboard();
    setInterval(fetchLeaderboard, 30_000); // refresh every 30s
  })();
  </script>
</body>
</html>
